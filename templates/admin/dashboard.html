{% extends "base.html" %}

{% block title %}Admin Dashboard - AstraZeneca Clinical Trials{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-astra-purple">
            <i class="fas fa-tachometer-alt me-3"></i>
            Admin Dashboard
        </h1>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-success me-2">
                <i class="fas fa-user-shield me-1"></i>Admin Logged In
            </span>
            <button class="btn btn-outline-astra-purple" onclick="location.reload()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ stats.total }}</h3>
                            <p class="mb-0">Total Submissions</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ stats.eligible }}</h3>
                            <p class="mb-0">Eligible Participants</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ stats.not_eligible }}</h3>
                            <p class="mb-0">Under Review</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card text-white" style="background-color: #8A0051;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ stats.emails_sent }}</h3>
                            <p class="mb-0">Emails Sent</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-envelope fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Therapy Type Statistics -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card text-white" style="background-color: #17a2b8;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ stats.general }}</h3>
                            <p class="mb-0">General Interest</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-notes-medical fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card text-white" style="background-color: #6f42c1;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ stats.cell_therapy }}</h3>
                            <p class="mb-0">Cell Therapy Interest</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-dna fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-search me-2"></i>
                Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="search_pincode" class="form-label">Search by Pincode</label>
                    <input type="text" class="form-control" id="search_pincode" name="search_pincode" 
                           value="{{ current_pincode }}" placeholder="Enter pincode">
                </div>
                <div class="col-md-3">
                    <label for="eligibility_filter" class="form-label">Eligibility Status</label>
                    <select class="form-select" id="eligibility_filter" name="eligibility_filter">
                        <option value="">All Participants</option>
                        <option value="eligible" {{ 'selected' if current_eligibility == 'eligible' }}>Eligible Only</option>
                        <option value="not_eligible" {{ 'selected' if current_eligibility == 'not_eligible' }}>Under Review Only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="therapy_filter" class="form-label">Therapy Type</label>
                    <select class="form-select" id="therapy_filter" name="therapy_filter">
                        <option value="">All Therapies</option>
                        <option value="general" {{ 'selected' if current_therapy == 'general' }}>General Interest</option>
                        <option value="cell_therapy" {{ 'selected' if current_therapy == 'cell_therapy' }}>Cell Therapy</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="d-grid gap-2 d-md-flex w-100">
                        <button type="submit" class="btn btn-astra-purple">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Clear
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Submissions Table -->
    <div class="card">
        <div class="card-header bg-astra-purple text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Participant Submissions ({{ submissions|length }} results)
            </h5>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-astra-yellow text-astra-purple" onclick="selectAll()">
                    <i class="fas fa-check-square me-2"></i>Select All
                </button>
                <button type="button" class="btn btn-outline-light" onclick="clearSelection()">
                    <i class="fas fa-square me-2"></i>Clear All
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            {% if submissions %}
                <form id="emailForm" method="POST" action="{{ url_for('send_emails') }}">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)">
                                    </th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Mobile</th>
                                    <th>Pincode</th>
                                    <th>Age</th>
                                    <th>Therapy Type</th>
                                    <th>Eligibility</th>
                                    <th>Email Status</th>
                                    <th>Submitted</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for submission in submissions %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="selected_submissions" value="{{ submission.id }}" 
                                               class="submission-checkbox" onchange="updateSendButton()">
                                    </td>
                                    <td>
                                        <strong>{{ submission.name }}</strong>
                                    </td>
                                    <td>
                                        <a href="mailto:{{ submission.email }}" class="text-decoration-none">
                                            {{ submission.email }}
                                        </a>
                                    </td>
                                    <td>
                                        <a href="tel:{{ submission.mobile }}" class="text-decoration-none">
                                            {{ submission.mobile }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ submission.pincode }}</span>
                                    </td>
                                    <td>{{ submission.age }}</td>
                                    <td>
                                        {% if submission.therapy_type == 'cell_therapy' %}
                                            <span class="badge" style="background-color: #6f42c1; color: white;">
                                                <i class="fas fa-dna me-1"></i>Cell Therapy
                                            </span>
                                        {% else %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-notes-medical me-1"></i>General
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if submission.is_eligible %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Eligible
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Under Review
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if submission.email_sent %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-check-circle me-1"></i>Sent
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-minus-circle me-1"></i>Not Sent
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ submission.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="viewDetails({{ submission.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="p-3 bg-light border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span id="selectedCount" class="text-muted">0 selected</span>
                            </div>
                            <div>
                                <button type="submit" id="sendEmailsBtn" class="btn btn-astra-purple" disabled>
                                    <i class="fas fa-envelope me-2"></i>
                                    Send Emails to Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No submissions found</h5>
                    <p class="text-muted">
                        {% if current_pincode or current_eligibility %}
                            Try adjusting your search criteria or <a href="{{ url_for('admin_dashboard') }}">clear filters</a>.
                        {% else %}
                            No participant submissions have been received yet.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-astra-purple text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    Participant Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Checkbox management
function toggleAll(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.submission-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateSendButton();
}

function selectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = true;
    toggleAll(selectAllCheckbox);
}

function clearSelection() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = false;
    toggleAll(selectAllCheckbox);
}

function updateSendButton() {
    const checkboxes = document.querySelectorAll('.submission-checkbox:checked');
    const sendButton = document.getElementById('sendEmailsBtn');
    const selectedCount = document.getElementById('selectedCount');
    
    const count = checkboxes.length;
    sendButton.disabled = count === 0;
    selectedCount.textContent = `${count} selected`;
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.submission-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    if (count === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (count === allCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function viewDetails(submissionId) {
    // This would typically fetch details via AJAX
    // For now, we'll show a placeholder
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-astra-purple" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading participant details...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    modal.show();
    
    // Simulate loading delay
    setTimeout(() => {
        modalContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Detailed view functionality would be implemented here to show complete participant information,
                health details, and interaction history.
            </div>
        `;
    }, 1000);
}

// Email form confirmation
document.getElementById('emailForm').addEventListener('submit', function(e) {
    const selectedCount = document.querySelectorAll('.submission-checkbox:checked').length;
    if (selectedCount === 0) {
        e.preventDefault();
        alert('Please select at least one participant to send emails to.');
        return;
    }
    
    if (!confirm(`Are you sure you want to send emails to ${selectedCount} selected participants?`)) {
        e.preventDefault();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateSendButton();
});
</script>
{% endblock %}
