{% extends "base.html" %}

{% block title %}{{ trial.basic_info.brief_title }} - {{ trial.basic_info.nct_id }} | AstraZeneca{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<style>
    .trial-header {
        background: linear-gradient(135deg, #8A0051 0%, #6d003f 100%);
        color: white;
        border-radius: 20px;
        position: relative;
        overflow: visible;
        box-shadow: 0 8px 25px rgba(138, 0, 81, 0.3);
        margin-bottom: 3rem;
        margin-top: 1rem;
        min-height: 300px;
    }
    
    .trial-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="35" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="55" cy="75" r="4" fill="rgba(255,255,255,0.1)"/></svg>');
        animation: rotate 30s linear infinite;
        opacity: 0.3;
    }
    
    .trial-header .container {
        position: relative;
        z-index: 2;
    }
    
    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .info-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        background: #ffffff;
        border-left: 4px solid #EFAB00;
    }
    
    .info-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }
    
    .section-header {
        color: #8A0051;
        border-bottom: 3px solid #EFAB00;
        padding-bottom: 0.75rem;
        margin-bottom: 2rem;
        font-weight: 700;
        font-size: 1.4rem;
        position: relative;
    }
    
    .section-header::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 60px;
        height: 3px;
        background: #8A0051;
        border-radius: 2px;
    }
    
    .badge-custom {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .badge.status-recruiting,
    span.status-recruiting {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #28a745 !important;
    }
    
    .badge.status-active,
    span.status-active {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #28a745 !important;
    }
    
    .badge.status-completed,
    span.status-completed {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #6c757d !important;
    }
    
    .badge.status-not-yet-recruiting,
    .badge.status-not_yet_recruiting,
    span.status-not-yet-recruiting,
    span.status-not_yet_recruiting {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #dc3545 !important;
    }
    
    .badge.status-terminated,
    .badge.status-suspended,
    .badge.status-withdrawn,
    span.status-terminated,
    span.status-suspended,
    span.status-withdrawn {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #dc3545 !important;
    }
    
    .badge.status-unknown,
    span.status-unknown {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #6c757d !important;
    }
    
    .json-viewer {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .intervention-badge {
        background: var(--az-yellow);
        color: var(--az-primary);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.85rem;
        margin: 0.25rem;
        display: inline-block;
    }
    
    .contact-card {
        border-left: 4px solid #8A0051;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 0 12px 12px 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #8A0051, #6d003f) !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(138, 0, 81, 0.3);
    }
    
    .nav-pills .nav-link:not(.active) {
        color: #8A0051;
        background: transparent;
    }
    
    .nav-pills .nav-link:not(.active):hover {
        background: rgba(138, 0, 81, 0.1);
        color: #8A0051;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container-fluid px-4">
        <div class="container">
        <!-- Back Button -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="{{ url_for('celltherapy') }}" class="btn btn-outline-astra-purple">
                    <i class="fas fa-arrow-left me-2"></i>Back to Cell Therapy Trials
                </a>
            </div>
        </div>

        <!-- Trial Header -->
        <div class="trial-header mb-5">
            <div class="container py-5">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-4 fw-bold mb-3" style="line-height: 1.2;">{{ trial.basic_info.brief_title }}</h1>
                        {% if trial.basic_info.official_title and trial.basic_info.official_title != trial.basic_info.brief_title %}
                        <p class="lead opacity-90 mb-4" style="font-size: 1.1rem; line-height: 1.4;">{{ trial.basic_info.official_title }}</p>
                        {% endif %}
                        {% if trial.basic_info.acronym %}
                        <p class="h5 opacity-75 mb-3">Study Acronym: {{ trial.basic_info.acronym }}</p>
                        {% endif %}
                        <div class="d-flex flex-wrap gap-3 mb-4">
                            <span class="badge badge-custom fs-6 px-3 py-2 {% set status_lower = trial.basic_info.overall_status.lower().replace(' ', '-') %}{% if 'recruiting' in status_lower and 'not' not in status_lower %}status-recruiting{% elif 'active' in status_lower %}status-active{% elif 'completed' in status_lower %}status-completed{% elif 'not-yet-recruiting' in status_lower or 'not_yet_recruiting' in status_lower %}status-not-yet-recruiting{% elif 'terminated' in status_lower or 'suspended' in status_lower or 'withdrawn' in status_lower %}status-terminated{% else %}status-unknown{% endif %}">
                                {{ trial.basic_info.overall_status }}
                            </span>
                            {% if trial.basic_info.phases %}
                            <span class="badge fs-6 px-3 py-2" style="background-color: #ffffff; color: #000000; border: 2px solid #000000;">{{ ', '.join(trial.basic_info.phases) }}</span>
                            {% endif %}
                            <span class="badge fs-6 px-3 py-2" style="background-color: #ffffff; color: #000000; border: 2px solid #000000;">{{ trial.basic_info.study_type }}</span>
                        </div>
                    </div>
                    <div class="col-lg-4 text-center">
                        <div>
                            <h2 class="mb-1" style="font-size: 1.5rem;">{{ trial.basic_info.nct_id }}</h2>
                            <small class="opacity-75" style="font-size: 0.9rem;">ClinicalTrials.gov</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Information Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-6 col-lg-3">
                <div class="info-card card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="rounded-circle bg-gradient d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px; background: linear-gradient(135deg, #8A0051, #6d003f); box-shadow: 0 4px 15px rgba(138, 0, 81, 0.3);">
                            <span class="text-white" style="font-size: 2rem; font-weight: bold;">üìÖ</span>
                        </div>
                        <h6 class="card-title fw-bold text-astra-purple mb-2">Start Date</h6>
                        <p class="card-text fw-semibold text-dark">{{ trial.dates.start_date or 'Not specified' }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="info-card card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="rounded-circle bg-gradient d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px; background: linear-gradient(135deg, #EFAB00, #d4941a); box-shadow: 0 4px 15px rgba(239, 171, 0, 0.3);">
                            <span class="text-white" style="font-size: 2rem; font-weight: bold;">üë•</span>
                        </div>
                        <h6 class="card-title fw-bold mb-2" style="color: #EFAB00;">Target Enrollment</h6>
                        <p class="card-text fw-semibold text-dark">{{ trial.study_design.enrollment or 'Not specified' }} participants</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="info-card card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="rounded-circle bg-gradient d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px; background: linear-gradient(135deg, #28a745, #20c997); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                            <span class="text-white" style="font-size: 2rem; font-weight: bold;">üè¢</span>
                        </div>
                        <h6 class="card-title fw-bold text-success mb-2">Sponsor</h6>
                        <p class="card-text fw-semibold text-dark">{{ trial.sponsor_info.lead_sponsor }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="info-card card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="rounded-circle bg-gradient d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px; background: linear-gradient(135deg, #6f42c1, #563d7c); box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);">
                            <span class="text-white" style="font-size: 2rem; font-weight: bold;">üìç</span>
                        </div>
                        <h6 class="card-title fw-bold mb-2" style="color: #6f42c1;">Study Locations</h6>
                        <p class="card-text fw-semibold text-dark">
                            {% if trial.locations and trial.locations|length > 0 %}
                                {{ trial.locations|length }} site{% if trial.locations|length != 1 %}s{% endif %}
                            {% else %}
                                Sites TBD
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="row">
            <div class="col-12">
                <!-- Tab Navigation -->
                <ul class="nav nav-pills nav-fill mb-4 p-1 rounded-3" id="trialTabs" role="tablist" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-bold" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" style="border-radius: 12px;">
                            <i class="fas fa-chart-line me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="eligibility-tab" data-bs-toggle="tab" data-bs-target="#eligibility" type="button" role="tab" style="border-radius: 12px;">
                            <i class="fas fa-user-check me-2"></i>Eligibility
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations" type="button" role="tab">
                            <i class="fas fa-map-marker-alt me-2"></i>Locations
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                            <i class="fas fa-database me-2"></i>Full Data
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="trialTabsContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="card info-card">
                                    <div class="card-body">
                                        <h3 class="section-header">Study Description</h3>
                                        {% if trial.descriptions.brief_summary %}
                                        <h5>Brief Summary</h5>
                                        <p>{{ trial.descriptions.brief_summary }}</p>
                                        {% endif %}
                                        
                                        {% if trial.descriptions.detailed_description %}
                                        <h5>Detailed Description</h5>
                                        <p>{{ trial.descriptions.detailed_description }}</p>
                                        {% endif %}
                                        
                                        <h5>Study Design</h5>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <strong>Allocation:</strong> {{ trial.study_design.allocation or 'Not specified' }}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Intervention Model:</strong> {{ trial.study_design.intervention_model or 'Not specified' }}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Primary Purpose:</strong> {{ trial.study_design.primary_purpose or 'Not specified' }}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Masking:</strong> {{ trial.study_design.masking or 'Not specified' }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card info-card mb-4">
                                    <div class="card-body">
                                        <h5 class="section-header">Conditions</h5>
                                        {% for condition in trial.conditions_interventions.conditions %}
                                        <span class="badge bg-astra-purple text-white mb-2 me-1">{{ condition }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="card info-card mb-4">
                                    <div class="card-body">
                                        <h5 class="section-header">Interventions</h5>
                                        {% for intervention in trial.conditions_interventions.interventions %}
                                        <div class="intervention-badge">
                                            <strong>{{ intervention.type }}:</strong> {{ intervention.name }}
                                        </div>
                                        {% if intervention.description %}
                                        <p class="small text-muted mt-2">{{ intervention.description }}</p>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                {% if trial.conditions_interventions.keywords %}
                                <div class="card info-card">
                                    <div class="card-body">
                                        <h5 class="section-header">Keywords</h5>
                                        {% for keyword in trial.conditions_interventions.keywords %}
                                        <span class="badge bg-light mb-1 me-1" style="color: white;">{{ keyword }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Eligibility Tab -->
                    <div class="tab-pane fade" id="eligibility" role="tabpanel">
                        <div class="card info-card">
                            <div class="card-body">
                                <h3 class="section-header">Eligibility Criteria</h3>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-4">
                                        <div class="text-center p-4 rounded-3 border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #8A0051 !important;">
                                            <div class="rounded-circle bg-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; box-shadow: 0 4px 15px rgba(138, 0, 81, 0.2);">
                                                <i class="fas fa-user fa-2x text-astra-purple"></i>
                                            </div>
                                            <h6 class="fw-bold text-astra-purple">Gender</h6>
                                            <p class="mb-0 fw-semibold">{{ trial.eligibility.gender or 'All' }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-4 rounded-3 border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #EFAB00 !important;">
                                            <div class="rounded-circle bg-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; box-shadow: 0 4px 15px rgba(239, 171, 0, 0.2);">
                                                <i class="fas fa-clock fa-2x" style="color: #EFAB00;"></i>
                                            </div>
                                            <h6 class="fw-bold" style="color: #EFAB00;">Age Range</h6>
                                            <p class="mb-0 fw-semibold">{{ trial.eligibility.minimum_age or 'No min' }} - {{ trial.eligibility.maximum_age or 'No max' }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-4 rounded-3 border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #28a745 !important;">
                                            <div class="rounded-circle bg-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);">
                                                <i class="fas fa-shield-alt fa-2x text-success"></i>
                                            </div>
                                            <h6 class="fw-bold text-success">Healthy Volunteers</h6>
                                            <p class="mb-0 fw-semibold">{{ 'Yes' if trial.eligibility.healthy_volunteers else 'No' }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if trial.eligibility.criteria %}
                                <h5>Detailed Criteria</h5>
                                <div class="p-3 bg-light rounded">
                                    <pre class="mb-0" style="white-space: pre-wrap;">{{ trial.eligibility.criteria }}</pre>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Locations Tab -->
                    <div class="tab-pane fade" id="locations" role="tabpanel">
                        <!-- Map Section -->
                        {% if trial.locations %}
                        <div class="card info-card mb-4">
                            <div class="card-body p-0">
                                <div id="trial-locations-map" style="height: 500px; width: 100%; border-radius: 15px;"></div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <h5 class="text-astra-purple mb-3">All Study Sites</h5>
                        <div class="row g-4">
                            {% for location in trial.locations %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card info-card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-astra-purple">{{ location.facility_name or 'Facility Name Not Available' }}</h6>
                                        <div class="mb-2">
                                            <i class="fas fa-map-marker-alt text-astra-purple me-2"></i>
                                            {{ location.city }}, {{ location.state }} {{ location.zip_code }}
                                            <br>{{ location.country }}
                                        </div>
                                        {% if location.status %}
                                        <div class="mb-2">
                                            <span class="badge {% if 'recruiting' in location.status.lower() %}bg-success{% elif 'active' in location.status.lower() %}bg-primary{% else %}bg-secondary{% endif %}">
                                                {{ location.status }}
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% for contact in location.contacts %}
                                        <div class="contact-card mt-3">
                                            {% if contact.name %}
                                            <div class="fw-bold">{{ contact.name }}</div>
                                            {% endif %}
                                            {% if contact.phone %}
                                            <div><i class="fas fa-phone me-1"></i>{{ contact.phone }}</div>
                                            {% endif %}
                                            {% if contact.email %}
                                            <div><i class="fas fa-envelope me-1"></i>{{ contact.email }}</div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if not trial.locations %}
                            <div class="col-12">
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Location information is not available for this trial.
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Full Data Tab -->
                    <div class="tab-pane fade" id="details" role="tabpanel">
                        <div class="card info-card">
                            <div class="card-body">
                                <h3 class="section-header">Complete Trial Data (JSON)</h3>
                                <p class="text-muted mb-3">
                                    This section contains all available data from ClinicalTrials.gov for this study.
                                </p>
                                <div class="json-viewer">
                                    <pre><code>{{ trial.raw_data | tojson(indent=2) }}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <div class="p-4 rounded-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px dashed #8A0051;">
                    <h4 class="text-astra-purple mb-3">
                        <i class="fas fa-hands-helping me-2"></i>Interested in This Trial?
                    </h4>
                    <p class="text-muted mb-4">Connect with our team to learn more about participation opportunities</p>
                    <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                        <a href="{{ url_for('celltherapy_interest', nct_id=trial.basic_info.nct_id) }}" class="btn btn-lg px-4 py-3 fw-bold" style="background: linear-gradient(135deg, #8A0051, #6d003f); color: white; border-radius: 15px; box-shadow: 0 6px 20px rgba(138, 0, 81, 0.3);">
                            <i class="fas fa-user-plus me-2"></i>Express Interest in This Trial
                        </a>
                        <a href="https://clinicaltrials.gov/study/{{ trial.basic_info.nct_id }}" target="_blank" class="btn btn-outline-dark btn-lg px-4 py-3 fw-bold" style="border-radius: 15px; border-width: 2px;">
                            <i class="fas fa-external-link-alt me-2"></i>View on ClinicalTrials.gov
                        </a>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    var triggerTabList = [].slice.call(document.querySelectorAll('#trialTabs button'))
    triggerTabList.forEach(function (triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl)
    })
    
    // Smooth scrolling for any anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
    
    // Initialize map when Locations tab is shown
    var locationsTab = document.getElementById('locations-tab');
    if (locationsTab) {
        locationsTab.addEventListener('shown.bs.tab', function (event) {
            // Small delay to ensure tab is fully visible
            setTimeout(function() {
                initializeMap();
            }, 100);
        });
    }
});

var mapInstance = null;

function initializeMap() {
    // Check if map container exists
    var mapContainer = document.getElementById('trial-locations-map');
    if (!mapContainer) {
        console.log('Map container not found');
        return;
    }
    
    // Check if already initialized
    if (mapInstance) {
        console.log('Map already initialized, invalidating size');
        mapInstance.invalidateSize();
        return;
    }
    
    console.log('Initializing map...');
    
    // Get location data from template
    var locations = {{ trial.locations | tojson | safe }};
    console.log('Locations data:', locations);
    
    if (!locations || locations.length === 0) {
        console.log('No locations available');
        return;
    }
    
    // Filter locations that have coordinates
    var locationsWithCoords = locations.filter(function(loc) {
        return loc.geo_point && loc.geo_point.lat && loc.geo_point.lon;
    });
    
    console.log('Locations with coordinates:', locationsWithCoords.length);
    
    if (locationsWithCoords.length === 0) {
        mapContainer.innerHTML = '<div class="alert alert-info m-3">Location coordinates are not available for this trial.</div>';
        return;
    }
    
    // Initialize map centered on first location
    var firstLoc = locationsWithCoords[0];
    console.log('Creating map at:', firstLoc.geo_point.lat, firstLoc.geo_point.lon);
    
    mapInstance = L.map('trial-locations-map').setView([firstLoc.geo_point.lat, firstLoc.geo_point.lon], 4);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(mapInstance);
    
    // Create a bounds object to fit all markers
    var bounds = L.latLngBounds();
    
    // Add markers for each location
    locationsWithCoords.forEach(function(location) {
        var lat = location.geo_point.lat;
        var lon = location.geo_point.lon;
        
        // Use default Leaflet marker
        var marker = L.marker([lat, lon]).addTo(mapInstance);
        
        // Create popup content
        var popupContent = '<div style="min-width: 200px;">' +
            '<h6 class="text-astra-purple mb-2">' + (location.facility_name || 'Facility Name Not Available') + '</h6>' +
            '<p class="mb-1"><strong>üìç Location:</strong><br>' + 
            (location.city || '') + (location.city && location.state ? ', ' : '') + (location.state || '') + ' ' + (location.zip_code || '') + '<br>' +
            (location.country || '') + '</p>';
        
        if (location.status) {
            var statusClass = 'secondary';
            if (location.status.toLowerCase().includes('recruiting')) {
                statusClass = 'success';
            } else if (location.status.toLowerCase().includes('active')) {
                statusClass = 'primary';
            }
            popupContent += '<p class="mb-1"><span class="badge bg-' + statusClass + '">' + location.status + '</span></p>';
        }
        
        if (location.contacts && location.contacts.length > 0) {
            var contact = location.contacts[0];
            if (contact.name || contact.phone || contact.email) {
                popupContent += '<p class="mb-1"><strong>Contact:</strong><br>';
                if (contact.name) popupContent += contact.name + '<br>';
                if (contact.phone) popupContent += 'üìû ' + contact.phone + '<br>';
                if (contact.email) popupContent += 'üìß ' + contact.email;
                popupContent += '</p>';
            }
        }
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent);
        
        // Add to bounds
        bounds.extend([lat, lon]);
    });
    
    // Fit map to show all markers
    if (locationsWithCoords.length > 1) {
        mapInstance.fitBounds(bounds, { padding: [50, 50] });
    }
    
    // Force map to recalculate size
    setTimeout(function() {
        mapInstance.invalidateSize();
    }, 200);
    
    console.log('Map initialized successfully');
}
</script>
{% endblock %}